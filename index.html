<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JB Creations - Shipping Label Sorter</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè∑Ô∏è</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè∑Ô∏è JB Creations - Shipping Label Sorter</h1>
            <p>Upload your Flipkart, Amazon, and Meesho shipping labels together - automatic platform detection</p>
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="cropping" onclick="switchTab('cropping')">
                    ‚úÇÔ∏è Label Cropping
                </button>
                <button class="tab-btn" data-tab="sorting" onclick="switchTab('sorting')">
                    üìã Label Sorting
                </button>
                <button class="tab-btn" data-tab="counter" onclick="switchTab('counter')">
                    üî¢ Label Counter
                </button>
                <button class="tab-btn" data-tab="finder" onclick="switchTab('finder')">
                    üîé Label Finder
                </button>
            </nav>
        </header>

        <main>
            <!-- SORTING TAB CONTENT -->
            <div id="sorting-tab-content" class="tab-content">
            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <h2>Drop your PDF files here</h2>
                    <p>or click to browse (Ctrl+Click or Shift+Click to select multiple)</p>
                    <input type="file" id="fileInput" accept=".pdf" multiple>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" id="clearBtn" style="display: none;">
                        üóëÔ∏è Clear Files
                    </button>
                    <button class="btn btn-primary" id="processBtn" disabled>
                        Process & Sort Labels
                    </button>
                </div>
            </section>

            <section class="platform-info" id="platformInfo" style="display: none;">
                <h3>ÔøΩ Uploaded Files</h3>
                <div class="platform-stats" id="platformStats">
                    <!-- File names and page counts will be displayed here -->
                </div>
            </section>

            <section class="status-section" id="statusSection" style="display: none;">
                <div class="status-card">
                    <h3>Processing Status</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="statusText">Initializing...</p>
                </div>
            </section>

            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="results-card">
                    <h3>üìä Sorting Results</h3>
                    
                    <div class="platform-breakdown" id="platformBreakdown">
                        <h4>üì¶ Platform Breakdown</h4>
                        <div class="platform-breakdown-stats" id="platformBreakdownStats"></div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value" id="totalPages">0</span>
                            <span class="stat-label">Total Labels</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="matchedPages">0</span>
                            <span class="stat-label">Priority Labels Found</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="unmatchedPages">0</span>
                            <span class="stat-label">Other Labels</span>
                        </div>
                    </div>
                    
                    <div class="matched-labels" id="matchedLabels">
                        <h4>Priority Labels Found:</h4>
                        <div class="label-chips" id="labelChips"></div>
                    </div>
                    
                    <div class="stock-update-section">
                        <div id="stockUpdateStatus" style="display: none;"></div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" id="downloadBtn">
                            ‚¨áÔ∏è Download Sorted PDF
                        </button>
                        <button class="btn btn-secondary" id="updateStockBtn">
                            üìä Update Stock to Google Sheets
                        </button>
                    </div>
                </div>
            </section>

            <section class="priority-list-section">
                <details>
                    <summary>View Priority Label List</summary>
                    <div class="priority-list" id="priorityList"></div>
                    <button class="btn btn-edit" id="editLabelsBtn">
                        ‚úèÔ∏è Edit Priority Labels
                    </button>
                </details>
            </section>
            
            <section class="google-sheets-section">
                <h3>üìä Google Sheets Integration</h3>
                <p>Connect to your Google Sheet to automatically update stock counts when labels are processed.</p>
                <div class="sheets-status">
                    <span>Status: </span>
                    <span id="googleSheetsConnectionStatus">
                        <span class="status-disconnected">‚ö†Ô∏è Not Configured</span>
                    </span>
                </div>
                <button class="btn btn-secondary" id="configureGoogleSheetsBtn">
                    ‚öôÔ∏è Configure Google Sheets
                </button>
            </section>
            </div>
            <!-- END SORTING TAB CONTENT -->

            <!-- COUNTER TAB CONTENT -->
            <div id="counter-tab-content" class="tab-content">
                <div class="counter-header-actions">
                    <button class="btn btn-settings" id="labelCriteriaSettingsBtn" title="Configure label detection criteria">
                        ‚öôÔ∏è Label Detection Settings
                    </button>
                </div>
                <section class="upload-section">
                    <div class="upload-area" id="counterUploadArea">
                        <div class="upload-icon">üìä</div>
                        <h2>Drop your PDF label files here</h2>
                        <p>Upload labels from multiple platforms to count by courier and return address</p>
                        <input type="file" id="counterFileInput" accept=".pdf" multiple>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" id="counterClearBtn" style="display: none;">
                            üóëÔ∏è Clear Files
                        </button>
                        <button class="btn btn-primary" id="counterProcessBtn" disabled>
                            üî¢ Count Labels
                        </button>
                    </div>
                </section>

                <section class="counter-files-info" id="counterFilesInfo" style="display: none;">
                    <h3>üìÅ Uploaded Files</h3>
                    <div class="counter-files-list" id="counterFilesList"></div>
                </section>

                <section class="status-section" id="counterStatusSection" style="display: none;">
                    <div class="status-card">
                        <h3>Processing Status</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="counterProgressFill"></div>
                        </div>
                        <p id="counterStatusText">Initializing...</p>
                    </div>
                </section>

                <section class="counter-results-section" id="counterResultsSection" style="display: none;">
                    <div class="results-card">
                        <h3>üìä Label Count Results</h3>
                        
                        <div class="counter-summary">
                            <div class="stat-item">
                                <span class="stat-value" id="counterTotalLabels">0</span>
                                <span class="stat-label">Total Labels</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="counterTotalGroups">0</span>
                                <span class="stat-label">Return Address Groups</span>
                            </div>
                        </div>

                        <div class="counter-groups-container" id="counterGroupsContainer">
                            <!-- Dynamic groups will be inserted here -->
                            <!-- Example structure:
                            <div class="counter-group">
                                <div class="counter-group-header">
                                    <h4>XIDXID</h4>
                                    <span class="counter-group-total">TOTAL - 10</span>
                                </div>
                                <div class="counter-group-items">
                                    <div class="counter-item">
                                        <span class="courier-name">Delhivery</span>
                                        <span class="courier-count">5</span>
                                    </div>
                                </div>
                            </div>
                            -->
                        </div>

                        <div class="counter-output-section">
                            <h4>üìã Text Output</h4>
                            <pre id="counterTextOutput" class="counter-text-output"></pre>
                            <button class="btn btn-success" id="copyCounterResultsBtn">
                                üìã Copy Results
                            </button>
                            <span class="copy-feedback" id="copyFeedback" style="display: none;">‚úÖ Copied!</span>
                        </div>
                    </div>
                </section>
            </div>
            <!-- END COUNTER TAB CONTENT -->

            <!-- CROPPING TAB CONTENT -->
            <div id="cropping-tab-content" class="tab-content active">
                <section class="upload-section">
                    <div class="upload-area" id="croppingUploadArea">
                        <div class="upload-icon">‚úÇÔ∏è</div>
                        <h2>Drop your PDF label files here</h2>
                        <p>Upload shipping labels to crop &amp; format for thermal printing (4√ó6")</p>
                        <input type="file" id="croppingFileInput" accept=".pdf" multiple>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" id="croppingClearBtn" style="display: none;">
                            üóëÔ∏è Clear Files
                        </button>
                    </div>
                </section>

                <section class="cropping-files-info" id="croppingFilesInfo" style="display: none;">
                    <h3>üìÅ Uploaded Files</h3>
                    <div class="cropping-files-list" id="croppingFilesList"></div>
                </section>

                <section class="cropping-actions" id="croppingActions" style="display: none;">
                    <h3>üñ®Ô∏è Select Processing Mode</h3>
                    <p>Choose a platform or let us detect automatically</p>
                    <div class="cropping-btn-group">
                        <button class="btn cropping-btn cropping-btn-auto" id="croppingAutoBtn">
                            üîÑ Automatic
                        </button>
                        <button class="btn cropping-btn cropping-btn-meesho" id="croppingMeeshoBtn">
                            üõçÔ∏è Meesho
                        </button>
                        <button class="btn cropping-btn cropping-btn-flipkart" id="croppingFlipkartBtn">
                            üì¶ Flipkart
                        </button>
                        <button class="btn cropping-btn cropping-btn-amazon" id="croppingAmazonBtn">
                            üõí Amazon
                        </button>
                    </div>
                </section>

                <section class="status-section" id="croppingStatusSection" style="display: none;">
                    <div class="status-card">
                        <h3>Processing Status</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="croppingProgressFill"></div>
                        </div>
                        <p id="croppingStatusText">Initializing...</p>
                    </div>
                </section>

                <section class="cropping-results-section" id="croppingResultsSection" style="display: none;">
                    <div class="results-card">
                        <h3>üìä Cropping Results</h3>
                        <div class="cropping-summary">
                            <div class="stat-item">
                                <span class="stat-value" id="croppingTotalProcessed">0</span>
                                <span class="stat-label">Labels Processed</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="croppingPlatformCount">0</span>
                                <span class="stat-label">Platforms Detected</span>
                            </div>
                        </div>

                        <div class="cropping-output-list" id="croppingOutputList">
                            <!-- Dynamic per-platform download cards -->
                        </div>

                        <button class="btn btn-success" id="croppingDownloadAllBtn">
                            ‚¨áÔ∏è Download All Processed PDFs
                        </button>
                    </div>
                </section>
            </div>
            <!-- END CROPPING TAB CONTENT -->

            <!-- FINDER TAB CONTENT -->
            <div id="finder-tab-content" class="tab-content">
                <section class="finder-search-section">
                    <div class="finder-courier-filter-row" id="finderCourierFilterRow">
                        <button class="finder-courier-btn" data-finder-courier="ekart">E-Kart</button>
                        <button class="finder-courier-btn" data-finder-courier="xpressbees">Xpress Bees</button>
                        <button class="finder-courier-btn" data-finder-courier="shadowfax">Shadowfax</button>
                        <button class="finder-courier-btn" data-finder-courier="delhivery">Delhivery</button>
                        <button class="finder-courier-btn" data-finder-courier="valmo">Valmo</button>
                    </div>
                    <div class="finder-search-row">
                        <input type="text" id="finderSearchInput" placeholder="Enter tracking number (type 3+ chars)">
                        <label class="finder-print-toggle">
                            <input type="checkbox" id="finderIncludeInvoiceToggle" checked>
                            Print with invoice
                        </label>
                        <button class="btn btn-success" id="finderPrintBtn" disabled>
                            üñ®Ô∏è Print
                        </button>
                    </div>
                </section>

                <section class="finder-results-section">
                    <div class="results-card">
                        <h3>üéØ Results</h3>
                        <div id="finderResultsList" class="finder-results-list"></div>
                    </div>
                </section>

                <section class="finder-preview-section">
                    <div class="results-card">
                        <h3>üëÅÔ∏è Label Preview</h3>
                        <p id="finderSelectedMeta" class="finder-selected-meta"></p>
                        <div class="finder-preview-grid">
                            <div class="finder-preview-item">
                                <h4>Label Page</h4>
                                <canvas id="finderLabelCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="finder-history-section">
                    <div class="results-card">
                        <h3>üóÇÔ∏è History</h3>
                        <div id="finderHistoryList" class="finder-history-list"></div>
                    </div>
                </section>
            </div>
            <!-- END FINDER TAB CONTENT -->

            <!-- Password Modal -->
            <div class="modal" id="passwordModal" style="display: none;">
                <div class="modal-content">
                    <h3>üîí Enter Password</h3>
                    <p id="passwordModalMessage">Enter password to edit priority labels</p>
                    <input type="password" id="passwordInput" placeholder="Enter password">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" id="cancelPasswordBtn">Cancel</button>
                        <button class="btn btn-primary" id="submitPasswordBtn">Submit</button>
                    </div>
                    <p class="error-message" id="passwordError" style="display: none;">Incorrect password!</p>
                </div>
            </div>

            <!-- Edit Labels Modal -->
            <div class="modal" id="editLabelsModal" style="display: none;">
                <div class="modal-content modal-large">
                    <h3>‚úèÔ∏è Edit Priority Labels</h3>
                    <p>Enter one label per line. Labels will be prioritized in the order listed.</p>
                    <div class="cloud-sync-info">
                        <span class="cloud-icon">‚òÅÔ∏è</span>
                        <span>Changes will be saved to the cloud and synced across all devices</span>
                    </div>
                    <textarea id="labelsTextarea" rows="20"></textarea>
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                        <button class="btn btn-primary" id="saveLabelsBtn">üíæ Save Labels</button>
                    </div>
                </div>
            </div>
            
            <!-- Google Sheets Configuration Modal -->
            <div class="modal" id="googleSheetsModal" style="display: none;">
                <div class="modal-content modal-large">
                    <h3>üìä Configure Google Sheets</h3>
                    <p>Connect your Google Sheet for automatic stock updates.</p>
                    
                    <div class="form-group">
                        <label for="sheetsIdInput">Spreadsheet ID:</label>
                        <input type="text" id="sheetsIdInput" placeholder="e.g., 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                        <small>Find this in your Google Sheet URL between /d/ and /edit</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sheetNameInput">Sheet Name:</label>
                        <input type="text" id="sheetNameInput" placeholder="STOCK COUNT" value="STOCK COUNT">
                        <small>The name of the tab in your spreadsheet where stock is stored (Column A = Labels, Column B = Stock)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="webAppUrlInput">Web App URL:</label>
                        <input type="text" id="webAppUrlInput" placeholder="https://script.google.com/macros/s/...">
                        <small>Deploy the Google Apps Script and paste the Web App URL here</small>
                    </div>
                    
                    <div class="setup-instructions">
                        <details>
                            <summary>üìã How to set up Google Apps Script</summary>
                            <ol>
                                <li>Open your Google Sheet</li>
                                <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                                <li>Delete any existing code and paste the script (see below)</li>
                                <li>Save the script (Ctrl+S)</li>
                                <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                                <li>Select <strong>"Web app"</strong> as the type</li>
                                <li>Set "Execute as" to <strong>"Me"</strong></li>
                                <li>Set "Who has access" to <strong>"Anyone"</strong></li>
                                <li>Click Deploy and authorize</li>
                                <li>Copy the Web App URL and paste it above</li>
                            </ol>
                            <div class="script-code">
                                <p><strong>Google Apps Script Code:</strong></p>
                                <pre id="appsScriptCode">
function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    
    if (data.action === 'deductStock') {
      var sheetName = data.sheetName || 'Sheet1';
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      
      if (!sheet) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          message: 'Sheet not found: ' + sheetName
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      var labelCounts = data.labelCounts;
      var dataRange = sheet.getDataRange();
      var values = dataRange.getValues();
      
      for (var label in labelCounts) {
        var deductAmount = labelCounts[label];
        for (var i = 1; i < values.length; i++) {
          var cellLabel = String(values[i][0]).toLowerCase().trim();
          var searchLabel = label.toLowerCase().trim();
          
          if (cellLabel === searchLabel) {
            var currentStock = Number(values[i][1]) || 0;
            var newStock = Math.max(0, currentStock - deductAmount);
            sheet.getRange(i + 1, 2).setValue(newStock);
            break;
          }
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true
      })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'ok'
  })).setMimeType(ContentService.MimeType.JSON);
}
                                </pre>
                                <button class="btn btn-copy" onclick="copyAppsScript()">üìã Copy Script</button>
                            </div>
                        </details>
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" id="cancelSheetsConfigBtn">Cancel</button>
                        <button class="btn btn-primary" id="saveSheetsConfigBtn">Save Configuration</button>
                    </div>
                </div>
            </div>

            <!-- Label Detection Criteria Settings Modal -->
            <div class="modal" id="labelCriteriaModal" style="display: none;">
                <div class="modal-content modal-large">
                    <h3>‚öôÔ∏è Label Detection Criteria Settings</h3>
                    <p>Configure how labels are detected and categorized from different platforms.</p>
                    
                    <div class="criteria-section">
                        <h4>üõí Meesho Label Detection</h4>
                        
                        <div class="form-group">
                            <label for="meeshoReturnAddressPattern">Return Address Pattern (Regex):</label>
                            <input type="text" id="meeshoReturnAddressPattern" placeholder="/if\s+undelivered,?\s+return\s+to:?\s*([A-Za-z0-9_-]+)/i">
                            <small>Regex pattern to extract return address from Meesho labels</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="meeshoCouriers">Courier Names (comma-separated):</label>
                            <input type="text" id="meeshoCouriers" placeholder="DELHIVERY, SHADOWFAX, VALMO, XPRESS BEES">
                            <small>List of courier names to identify Meesho labels (must include PICKUP keyword)</small>
                        </div>
                    </div>
                    
                    <div class="criteria-section">
                        <h4>üì¶ Flipkart Label Detection</h4>
                        
                        <div class="form-group">
                            <label for="flipkartShippingAddressKeyword">Shipping Address Keyword:</label>
                            <input type="text" id="flipkartShippingAddressKeyword" placeholder="Shipping/Customer address:">
                            <small>Keyword that identifies a Flipkart shipping label</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="flipkartSoldByPattern">Sold By Pattern (Regex):</label>
                            <input type="text" id="flipkartSoldByPattern" placeholder="/Sold\s+By:?\s*([A-Za-z0-9\s_-]+?)(?:\s*,|\s*\n|\s*$|\s+[A-Z])/i">
                            <small>Regex pattern to extract seller name from Flipkart labels</small>
                        </div>
                    </div>
                    
                    <div class="cloud-sync-info">
                        <span class="cloud-icon">‚òÅÔ∏è</span>
                        <span>Settings will be saved locally and synced to Google Sheets if configured</span>
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" id="cancelCriteriaBtn">Cancel</button>
                        <button class="btn btn-secondary" id="resetCriteriaBtn">üîÑ Reset to Defaults</button>
                        <button class="btn btn-primary" id="saveCriteriaBtn">üíæ Save Settings</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 JB Creations. Built for efficient label management.</p>
        </footer>
    </div>

    <!-- Device Access Modal (first-time per device) -->
    <div class="modal" id="deviceAuthModal" style="display: none;">
        <div class="modal-content">
            <h3>üîê Device Verification</h3>
            <p>Enter passcode to access this website on this device.</p>
            <input type="password" id="deviceAuthInput" placeholder="Enter passcode">
            <div class="modal-buttons">
                <button class="btn btn-primary" id="deviceAuthSubmitBtn">Unlock</button>
            </div>
            <p class="error-message" id="deviceAuthError" style="display: none;">Incorrect passcode!</p>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        function copyAppsScript() {
            const scriptCode = document.getElementById('appsScriptCode').textContent;
            navigator.clipboard.writeText(scriptCode.trim()).then(() => {
                alert('‚úÖ Script copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }
    </script>
</body>
</html>
